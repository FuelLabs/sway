<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Error Handling - The Sway Programming Language</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">The Sway Programming Language</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/FuelLabs/sway" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="error-handling"><a class="header" href="#error-handling">Error Handling</a></h1>
<h2 id="recoverable-errors"><a class="header" href="#recoverable-errors">Recoverable Errors</a></h2>
<p>Recoverable errors represent expected faults. Similar to Rust, Sway expresses recoverable errors by using the <code>std::result::Result</code> enum, letting you propagate or transform the error without immediately reverting the transaction.</p>
<p>To learn more about expressing and handling recoverable errors, see the chapter on <a href="commonly_used_library_types.html#resultt-e"><code>Result&lt;T, E&gt;</code> enum</a>.</p>
<h2 id="irrecoverable-errors"><a class="header" href="#irrecoverable-errors">Irrecoverable Errors</a></h2>
<p>Irrecoverable errors indicate bugs or violated invariants. They trigger a VM-wide revert that atomically rolls back every state change in the transaction, and it cannot be caught or handled in Sway code, signaling that the program cannot sensibly continue.</p>
<h3 id="panic-expression"><a class="header" href="#panic-expression"><code>panic</code> Expression</a></h3>
<p>The recommended way of expressing an irrecoverable errors is to use the <code>panic</code> expression:</p>
<pre><code class="language-sway">if some_error_occurred {
    panic "Some error has occurred.";
}
</code></pre>
<p>At runtime, the <code>panic</code> expression aborts and reverts the execution of the entire program. At compile time, for each <code>panic</code> encountered in code, Sway compiler will generate a unique revert code and create an entry in the ABI JSON <code>errorCodes</code> section. The generated <code>errorCodes</code> entry will contain the information about the source location at which the <code>panic</code> occurs, as well as the error message.</p>
<p>In addition, for each function call that might panic, compiler will generate an entry in the ABI JSON <code>panickingCalls</code> section. Those entries will contain source locations of functions whose calls might eventually end up in calling a <code>panic</code> somewhere in the call chain.</p>
<p><strong>Combined together, these two ABI JSON entries, <code>errorCodes</code> and <code>panickingCalls</code>, allow for getting a rich troubleshooting information, that contains the error location and a partial backtrace, without any or negligible additional on-chain cost.</strong></p>
<p>The generated bytecode will contain only the revert instructions, while error messages and error locations will be stored off-chain, in the ABI JSON file, making the <code>panic</code>king a zero on-chain cost operation. Panic backtrace comes with only a negligible on-chain cost, that can additionally be opted-in or out, as explained in detail in the chapter <a href="#configuring-the-backtrace-content">Configuring the Backtrace Content</a>.</p>
<p><em>Partial</em> backtrace means that the <em>backtrace is limited to up to five function calls</em>. In practice, deeper call chains are rare. Also, it is possible to choose which functions should be a part of the reported backtrace. This is done by using the <code>backtrace</code> build option and the <code>#[trace]</code> attribute, as also explained in detail in the chapter <a href="#configuring-the-backtrace-content">Configuring the Backtrace Content</a>.</p>
<p>Tools like Rust and TypeScript SDKs and <code>forc test</code> recognize revert codes generated by <code>panic</code> expressions. E.g., if a Sway unit test fails because of a revert caused by the above <code>panic</code> line, <code>forc test</code> might display an output similar to the following:</p>
<pre><code class="language-console">test some_test, "/tests.sw":42
    revert code: 8100000000000000
    ├─ panic message: Some error has occurred.
    ├─ panicked:      in some_package::some_error_occurred
    │                  └─ at some_package@1.2.3, src/some_module.sw:13:9
    └─ backtrace:     called in some_other_package::some_other_module::some_function
                       └─ at some_other_package@1.2.3, src/some_other_module.sw:106:11
                      called in my_project::some_test
                       └─ at my_project, src/tests.sw:48:8
</code></pre>
<p>What the above panic location and the backtrace are telling us, is that <code>some_test</code> has called <code>some_function</code> that has called <code>some_error_occurred</code> which has panicked with the message "Some error has occurred."</p>
<h3 id="error-types"><a class="header" href="#error-types">Error Types</a></h3>
<p>Passing textual error messages directly as a <code>panic</code> argument is the most convenient way to provide a helpful error message. It is sufficient for many use-cases. However, sometimes we want:</p>
<ul>
<li>to provide an additional runtime information about the error,</li>
<li>or to group a certain family of errors together.</li>
</ul>
<p>For these use-cases, you can use <em>error types</em>. Error types are enums annotated with the <code>#[error_type]</code> attribute, whose all variants are attributed with the <code>#[error(m = "&lt;error message&gt;")]</code> attributes. Each variant represent a particular error, and the enum itself the family of errors. The convention is to postfix the names of error type enums with <code>Error</code>.</p>
<p>For example, let's assume we are checking if a provided <code>Identity</code> has certain access rights to our contract. The error type enum representing access rights violations could look like:</p>
<pre><code class="language-sway">#[error_type]
pub enum AccessRightError {
    #[error(m = "The provided identity is not an administrator.")]
    NotAnAdmin: Identity,
    #[error(m = "The provided identity is not an owner.")]
    NotAnOwner: Identity,
    #[error(m = "The provided identity does not have write access.")]
    NoWriteAccess: Identity,
}
</code></pre>
<p>where each <code>Identity</code> represents the actual, provided identity.</p>
<p>In code, we can now check for access rights and panic if they are violated:</p>
<pre><code class="language-sway">fn do_something_that_requires_admin_access(admin: Identity) {
    if !is_admin(admin) {
        panic AccessRightError::NotAnAdmin(admin);
    }
    // ...
}
</code></pre>
<p>Assuming we have a failing test for the above function, the test output will show the error message, but also the provided <code>Identity</code> as the <em>panic value</em>. E.g.:</p>
<pre><code class="language-console">test some_test_for_admin_access, "/test.sw":42
    revert code: 8100000000000000
    ├─ panic message: The provided identity is not an administrator.
    ├─ panic value:   NotAnAdmin(Address(Address(79fa8779bed2f36c3581d01c79df8da45eee09fac1fd76a5a656e16326317ef0)))
    ├─ panicked:      in auth_package::only_admin
    │                  └─ at auth_package@0.1.0, src/admin_access.sw:11:9
    └─ backtrace:     ...
</code></pre>
<h3 id="errorcodes-and-panickingcalls-abi-json-entries"><a class="header" href="#errorcodes-and-panickingcalls-abi-json-entries"><code>errorCodes</code> and <code>panickingCalls</code> ABI JSON Entries</a></h3>
<p>To explain how <code>errorCodes</code> and <code>panickingCalls</code> are used to provide error information and backtrace, let's consider the following example:</p>
<ul>
<li>a function <code>only_admin</code> is defined in the <code>auth_package</code> and it panics if the identity is not an admin.</li>
<li><code>only_admin</code> is called in various guard functions that check preconditions, defined in the <code>guards_package</code>. E.g., <code>check_access_rights</code>.</li>
<li>those <code>guards_package</code> functions are used within the <code>funds_contract</code>.</li>
</ul>
<p>At compile time, an entry similar to these will be added to the ABI JSON <code>errorCodes</code> and <code>panickingCalls</code> sections:</p>
<pre><code class="language-json">"errorCodes": {
    "0": { // Unique ID of a `panic` call.
        "pos": { // Location in code, at which the `panic` call occurs.
          "pkg": "auth_package@1.2.3",
          "function": "auth_package::admin_access::only_admin",
          "file": "src/admin_access.sw",
          "line": 13,
          "column": 9
        },
        "logId": "10098701174489624218", // Log ID representing the `AccessRightError` enum
                                         // passed as an argument to `panic`.
        "msg": null,
    },
    // Other error codes for other `panic` calls.
},

"panickingCalls": {
    "1": { // Unique ID of a potentially panicking function call.
        "pos": { // Location in code, at which the function call that might panic occurs.
            "function": "guards_package::preconditions::check_admin", // The caller function, `check_admin`.
            "pkg": "guards_package@0.1.0",
            // Position within the `check_admin` where `only_admin` is called.
            "file": "src/preconditions.sw",
            "line": 4,
            "column": 9
        },
        "function": "auth_package::admin_access::only_admin" // The called function, `only_admin`.
    },
    // Other panicking calls.
}
</code></pre>
<p>Those unique error and panicking call IDs are embedded by the compiler into the revert code generated for a particular <code>panic</code> call.</p>
<p>In case of a revert, tools like SDKs and <code>forc test</code> will extract those IDs from the received revert code and using the information contained in the ABI JSON provide a rich troubleshooting details. In the above example, in case of a failing test, <code>forc test</code> might display an output similar to the following:</p>
<pre><code class="language-console">test some_test, "/tests.sw":42
    revert code: 8280000000000003
    ├─ panic message: The provided identity is not an administrator.
    ├─ panic value:   NotAnAdmin(Address(Address(79fa8779bed2f36c3581d01c79df8da45eee09fac1fd76a5a656e16326317ef0)))
    ├─ panicked:      in auth_package::admin_access::only_admin
    │                  └─ at auth_package@1.2.3, src/admin_access.sw:13:9
    └─ backtrace:     called in guards_package::preconditions::check_admin
                       └─ at guards_package@0.1.0, src/preconditions.sw:4:9
                      called in guards_package::preconditions::check_access_rights
                       └─ at guards_package@0.1.0, src/preconditions.sw:23:13
                      called in guards_package::preconditions::check_preconditions
                       └─ at guards_package@0.1.0, src/preconditions.sw:57:9
                      called in &lt;Contract as Funds&gt;::transfer_funds
                       └─ at funds_contract@0.2.5, src/main.sw:22:9
</code></pre>
<h2 id="configuring-the-backtrace-content"><a class="header" href="#configuring-the-backtrace-content">Configuring the Backtrace Content</a></h2>
<h3 id="in-default-builds"><a class="header" href="#in-default-builds">In Default Builds</a></h3>
<p>Backtracing comes with a minimal on-chain cost, in terms of the bytecode size and gas usage. To additionally allow you to opt-in even for this minimal cost, backtracing is configurable via dedicated <code>backtrace</code> build option, with different default values for <code>debug</code> and <code>release</code> builds.</p>
<p>To explain this build option, let us use the following example. We will have five functions named <code>first</code>, <code>second</code>, ..., <code>fifth</code> that call each other sequentially, and the function <code>fifth</code> finally calling a failing <code>assert_eq</code> that <code>panic</code>s.</p>
<p>In the default <code>debug</code> build, the output of a failing <code>forc test</code> will look similar to this (package names and code locations are omitted for brevity):</p>
<pre><code class="language-console">test some_test, "test.sw":42
    revert code: 8280000000000003
    ├─ panic message: The provided `expected` and `actual` values are not equal.
    ├─ panic value:   AssertEq(AssertEq { expected: 42, actual: 43 })
    ├─ panicked:      in std::assert::assert_eq
    │                  └─ at std@0.99.0, src/assert.sw:80:9
    └─ backtrace:     called in fifth
                       └─ at ...
                      called in fourth
                       └─ at ...
                      called in third
                       └─ at ...
                      called in second
                       └─ at ...
                      called in first
                       └─ at ...
</code></pre>
<p>In the default <code>release</code> build, the backtrace output will contain only the immediate call of the <code>assert_eq</code> that happens in the <code>fifth</code>:</p>
<pre><code class="language-console">    ...
    ├─ panicked:      in std::assert::assert_eq
    │                  └─ at std@0.99.0, src/assert.sw:80:9
    └─ backtrace:     called in fifth
                       └─ at ...
</code></pre>
<p>Where this difference in backtrace in <code>debug</code> and <code>release</code> build is coming from? In other words, how the compiler knows which functions to include into backtrace in different build profiles?</p>
<p>The backtrace can be directly influenced by using the <code>#[trace]</code> attribute in your code. Similarly to the <code>#[inline]</code> attribute, the <code>#[trace]</code> attribute can be used on all functions that have implementations. Same like <code>#[inline]</code>, it also comes with two arguments, <code>always</code> and <code>never</code>.</p>
<p>The <code>#[trace(always)]</code> instructs the compiler to include the calls of annotated functions in the backtrace in default <code>release</code> builds. This attribute should be used to annotate guard functions, like, e.g., <code>assert</code>, <code>assert_eq</code>, <code>require</code>, and <code>only_owner</code>, or methods like <code>Option::unwrap</code>. When such functions panic, we are actually interested in the places in code in which a failing call happens. E.g., having <code>#[trace(always)]</code> on the <code>assert</code> function helps us to see <em>which actual <code>assert</code> call has failed</em>.</p>
<p><strong>By default, <code>release</code> builds will include in the backtrace only the calls to functions annotated with <code>#[trace(always)]</code>.</strong> This minimizes the anyhow low on-chain cost of backtrace calculation only to function calls of those function, giving almost a zero on-chain impact while still providing a valuable troubleshooting information.</p>
<p>By using <code>#[trace(never)]</code> you can instruct the compiler <em>not to include a function in a backtrace</em>, even not in a default <code>debug</code> build, which otherwise includes all the panicking calls into backtrace. This is useful, considering that the backtrace will be limited to five functions only. If an intermediate function call can be easily deducted, it might be worth not having it in the backtrace.</p>
<p>E.g., let's assume that the functions <code>fourth</code> and <code>second</code> are annotated with <code>#[trace(never)]</code>. The default <code>debug</code> build would then output the following backtrace:</p>
<pre><code class="language-console">    ...
    ├─ panicked:      in std::assert::assert_eq
    │                  └─ at std@0.99.0, src/assert.sw:80:9
    └─ backtrace:     called in fifth
                       └─ at ...
                      called in third
                       └─ at ...
                      called in first
                       └─ at ...
</code></pre>
<h3 id="in-custom-builds"><a class="header" href="#in-custom-builds">In Custom Builds</a></h3>
<p>To change this default behavior, use the <code>backtrace</code> build option. The possible values for the <code>backtrace</code> build option, and their meanings are given in the below table.</p>
<div class="table-wrapper"><table><thead><tr><th>Value</th><th>Meaning</th></tr></thead><tbody>
<tr><td>all</td><td>Backtrace all function calls, even of functions annotated with <code>#[trace(never)]</code>.</td></tr>
<tr><td>all_except_never</td><td>Backtrace all function calls, except those of functions annotated with <code>#[trace(never)]</code>. This is the default value for <code>debug</code> builds.</td></tr>
<tr><td>only_always</td><td>Backtrace only calls of functions annotated with <code>#[trace(always)]</code>. This is the default value for <code>release</code> builds.</td></tr>
<tr><td>none</td><td>Do not backtrace any function calls. Use this option only if you need to fully remove the on-chain cost of backtracing. Considering how negligible the cost is, this will very likely never be needed.</td></tr>
</tbody></table>
</div>
<p>To learn more about custom builds, see <a href="../forc/manifest_reference.html#the-build-profile-section">The <code>[build-profile.*]</code> Section</a>.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../basics/control_flow.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../blockchain-development/index.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../basics/control_flow.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../blockchain-development/index.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
